version: "3.9"
volumes:
    php-fpm-socket:
    db-store:
services:
    app:
        build:
            context: .
            dockerfile: ./infra/docker/php/Dockerfile
        volumes:
            - type: volume
              source: php-fpm-socket
              target: /var/run/php-fpm
              volume:
                  nocopy: true
            - type: bind
              source: ./backend
              target: /work/backend
        environment:
            - DB_CONNECTION=mysql
            - DB_HOST=db
            - DB_PORT=3306
            - DB_DATABASE=Tokyo
            - DB_USERNAME=root
            - DB_PASSWORD=root

    web:
        build:
            context: .
            dockerfile: ./infra/docker/nginx/Dockerfile
        ports:
            - target: 80
              published: ${WEB_PORT:-80}
              protocol: tcp
              mode: host
        volumes:
            - type: volume
              source: php-fpm-socket
              target: /var/run/php-fpm
              volume:
                  nocopy: true
            - type: bind
              source: ./backend
              target: /work/backend

    db:
        build:
            context: .
            dockerfile: ./infra/docker/mysql/Dockerfile
        ports:
            - target: 3306
              published: ${DB_PORT:-3306}
              protocol: tcp
              mode: host
        volumes:
            - type: volume
              source: db-store
              target: /var/lib/mysql
              volume:
                  nocopy: true
        environment:
            - MYSQL_DATABASE=Tokyo
            - MYSQL_USER=root
            - MYSQL_PASSWORD=root
            - MYSQL_ROOT_PASSWORD=root
